---
title: "Adventures in data presenting: Covid-19"
date: 2020-03-18
draft: false
description: "A quick write up of my hobby project experimenting with parsing and presenting some data on the corona virus"
---
While I'm finishing the last touches on my graduation thesis (posts about that will follow soon) I wanted to take my mind off a little bit with some hobby. I have always been fascinated by presenting data in a clear and automated way and wanted to experiment a bit with that. As a subject for this I chose the big crisis of this moment: the corona virus or Covid-19. This posts serves as quick write up documenting various scripts and tools that I used to experiment a bit with data visualization. You cant visualize anything without actual data so that was the first hurdle to solve!

## Collecting Covid-19 data
I wanted to visualize the spread and growth of the virus. With some quick googling there seems to be many, sometimes conflicting, data sources on this. I wanted to stick as much as possible to official government or scientific sources. The World Health Organization (WHO) publishes daily situation reports [here](https://www.who.int/emergencies/diseases/novel-coronavirus-2019/situation-reports). However these are pdf's generated from word which is generally difficult to parse.  
Many countries (including my own the Netherlands, more on that later) publish individual statistics in various formats. Gathering all of these would be an enormous task. Luckily for me the Johns Hopkins university in Baltimore, Maryland in the USA quite quickly published an [excellent dashboard](https://www.arcgis.com/apps/opsdashboard/index.html#/bda7594740fd40299423467b48e9ecf6), which draws from a manually curated database that is composed of information from sources of many individual countries as well as the WHO. Even better this data is published in simple csv format [on github](https://github.com/CSSEGISandData/COVID-19). For the worldwide part of my own visualization I decided to use this as source.  
For specifically the Netherlands the government agency working on health data is the RIVM, which publishes a [daily updated chart](https://www.rivm.nl/coronavirus-kaart-van-nederland-per-gemeente). Sadly they dont allow going back in time although you can download the data in csv format. I [reversed engineered](https://github.com/fboerman/covid-19-data/blob/master/download_old_rivm.py) their csv download link and managed to download a couple of days back as well. After that I wrote a script that checks every hour if there is a new updated csv from the site and then downloads it to my server. It turned out that the RIVM changes their way of visualization during the crisis and I had to change the script quite a couple of times to keep pulling in data. At first it was a specific url with csv, later they seem to be settling on a plugin that reads csv data that is neatly embedded into the html. A [quick python script](https://github.com/fboerman/covid-19-data/blob/master/extract_current_csv_rivm.py) solved the extraction for this. An archive of all data that I managed to retrieve can be found [here on my github](https://github.com/fboerman/covid-19-data/tree/master/nederland/RIVM).  
With the data collected onwards to the visualization!

## Visualizing in Grafana
My goal for visualizing was that it should be easy to change, open source and look nice. After trying multiple options I was most impressed with [grafana](https://grafana.com/). Although there are many configuration options and I have only explored the basics, creating graphs of the growth of the virus was easily done. For now I stick to simple line and bar charts but they already are quite informing. The end result after some tinkering can be found at my self hosted grafana instance located at [https://data.boerman.dev/](https://data.boerman.dev/). There are dashboards for all cities in the Netherlands as well as countries per continent or specific individual countries, all detailing the amount of corona virus cases. They mostly work on mobile too. Im still trying to optimize the use of user input variables for a better user experience. For now simple selections of countries or municipalities is possible.


The biggest struggle was to get my collected data into grafana. Grafana supports a vast ammount of them, so it is easy to get overwhelmed in the beginning. I tried one of the most used ones, InnoDB, but found it quite difficult to get my data in the right format to fit into InnoDB. Especially frustrating was the fact that their bindings to my favourite language python was tricky to get working properly. So in the end I switched to a more standard general purpose database in the form of postgresql. For reading the actual csv files the excellent ```read_csv``` function from the [pandas python library](https://pandas.pydata.org/) was used. It supports a lot of very usefull tweaks, allowing for parsing almost any form of csv's. For example it is possible to tell it to skip certain rows and columns or for example empty lines when parsing. The resulting dataframe can then be processed for extra insights. In my case I wanted to create a table that also held the derivative of the data in order to plot it. With pandas this can be easily done with the ```diff``` function on a dataframe.  

For the worldwide data I also wanted a split between continents, after some searching I found the ```pycountry_convert``` library which can parse the name of a country to a country code and then assign a continent. The second part of the import script takes care of this. Due to John Hopkins not always using the official standarized names this required some manual renaming of input data in the script.  
When all parsing is done, the resulting dataframe tables can easily be written to postgresql with the ```to_sql``` routine, which through the sqlalchemy library supports postgresql natively.  

Cobbling this together resulted in two scripts, [one for the Netherlands data](https://github.com/fboerman/covid-19-data/blob/master/nederland/import.py) and [one for the world data](https://github.com/fboerman/covid-19-data/blob/master/world/import.py). By making heavily use of so many great python libraries (once again confirming my great love for the language and its ecosphere) the final scripts are relatively small in terms of lines of code. I have made an [overarching bash script](https://github.com/fboerman/covid-19-data/blob/master/update.sh) which runs on a timer (through systemd) on my server. It checks if there is any new data to download, and if so calls the parsing scripts after downloading. Grafana will then load this when a dashboard needs displaying, resulting in up to date data visualization!

## Staying informed: a telegram bot
I was quite happy with the results so far, but I also wanted to stay informed of the spread of the virus (and if my scripts keep running). To do this I made a relatively simple telegram bot, its source can be found [here](https://github.com/fboerman/covid19bot). Telegram is an alternative to WhatsApp with very good bot development support. For now the bot is focused on the Netherlands. It allows you to subscribe to one or more dutch cities and get messages with new RIVM data when they become available, as well as query the current top 20 infected cities in number of active cases. You can connect to it via telegram at the link: [t.me/Covid19NLNewsBot](t.me/Covid19NLNewsBot).


## Conclusion
In the end I'm quite happy with my shiny grafana dashboards, as well as my interactive bot. Although in the grand scheme of things fairly trivial, the setup of data gathering, parsing and displaying was very educational and a lot of fun. In the end this is obviously the goal of hobby projects such as these. To summarize the dashboards can be found at [https://data.boerman.dev/](https://data.boerman.dev/), all the scripts at [https://github.com/fboerman/covid-19-data](https://github.com/fboerman/covid-19-data).  
Next I'm planning to figure out the map plugin of grafana, as well as make a dashboard with live counters of the status of covid-19 worldwide.  
If you have any questions or possible feature requests hit me up via email [frank@fboerman.nl](mailto:frank@fboerman.nl) or telegram (@AwesomeFrank).

{{< ping key="covid19-1" >}}
